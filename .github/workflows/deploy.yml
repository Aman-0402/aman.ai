name: Deploy to GitHub Pages

# ─── Triggers ─────────────────────────────────────────────────────────────────
on:
  push:
    branches: [main]
  workflow_dispatch:          # Allow manual trigger from Actions UI

# ─── Permissions ──────────────────────────────────────────────────────────────
# These three are the minimum required for GitHub Pages OIDC deployment.
# Do NOT add extra permissions — principle of least privilege.
permissions:
  contents: read              # Checkout the repo
  pages: write                # Write to GitHub Pages deployment
  id-token: write             # Generate OIDC token (no PAT or secret needed)

# ─── Concurrency ──────────────────────────────────────────────────────────────
# Only one deployment at a time. cancel-in-progress: false means the current
# deploy FINISHES before the next one starts — prevents half-deployed states.
concurrency:
  group: pages
  cancel-in-progress: false

# ─── Jobs ─────────────────────────────────────────────────────────────────────
jobs:

  # ────────────────────────────────────────────────────────────────────────────
  # JOB 1 — BUILD
  # Compiles the React app and produces a deployable dist/ artifact.
  # Separated from deploy so a failed build never touches the live site.
  # ────────────────────────────────────────────────────────────────────────────
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      # ── MUST run before the build ──────────────────────────────────────────
      # configure-pages reads repo settings and outputs:
      #   base_path = '/'          when a verified custom domain is active
      #   base_path = '/aman.ai/'  when using the default subdomain
      #
      # PREREQUISITE: GitHub Pages source must be set to "GitHub Actions"
      # in repo Settings → Pages → Source. If it isn't, this step will fail
      # with "Error: Get Pages site failed". Fix: enable Pages in settings first.
      - name: Configure GitHub Pages
        id: pages
        uses: actions/configure-pages@v4

      # ── Inject base path at build time ────────────────────────────────────
      # Vite reads VITE_BASE_PATH in vite.config.js:
      #   base: process.env.VITE_BASE_PATH || '/'
      #
      # This sets the base URL for ALL asset references in the built HTML:
      #   With custom domain:  src="/assets/vendor.js"
      #   On subdomain:        src="/aman.ai/assets/vendor.js"
      #
      # Without this env var the assets load from the wrong path → white screen.
      - name: Build production bundle
        run: npm run build
        env:
          VITE_BASE_PATH: ${{ steps.pages.outputs.base_path }}

      # Upload dist/ directory as a Pages artifact (not a regular Actions artifact).
      # This is what deploy-pages will serve — not a gh-pages branch.
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  # ────────────────────────────────────────────────────────────────────────────
  # JOB 2 — DEPLOY
  # Pushes the artifact to GitHub Pages via the deployment API.
  # Only runs after build succeeds (needs: build).
  # ────────────────────────────────────────────────────────────────────────────
  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-latest

    # This creates the "github-pages" environment visible in the repo UI.
    # The live URL appears in the PR/commit status and the Deployments tab.
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
